---
title: "Data Processing"
author: "Team 2"
date: "2025-11-03"
output: pdf_document
---


```{r, eco=FALSE}

data <- read.csv("00_ProstateCancer_Data.csv", header=T)

```

```{r, eco=FALSE}

cols1 <- c("Tani_Tarihi", "Tedavi_Tarihi", "PSA_Takip_3ay", "PSA_Takip_6ay", "PSA_Takip_12ay", "BCR_Tarihi", "Metastaz_Tarihi", "Son_Takip_Tarihi")

data <- data[, !(names(data) %in% cols1)]

```

```{r, eco=FALSE}

cols2 <- c("Klinik_Evre", "Biyopsi_Gleason", "Risk_Grubu", "Komorbidite_Skor", "Tedavi_Tipi", "ADT_Tipi", "Patolojik_Evre", "Cerrahi_Sinir", "Final_Gleason", "BCR_Durum", "Metastaz_Durum", "Son_Durum")

data[cols2] <- lapply(data[cols2], as.factor)

```

```{r, eco=FALSE}

names(data) <- c("Patient ID", "Age", "PSA_before", "CTstage", "GleasonScore_before", "RiskClass", "Albumin", "Lymphocyte", "CRP", "NLR", "CallyIndex", "ComorbidityScore", "Treatment", "RadiationDose", "HormoneType", "HormonDuration" ,"TumorSize", "MarginStatus", "GleasonScore_after", "PSA_after", "BCR", "Metastasis", "Survival")

```

```{r, eco=FALSE}

data$Delta_PSA <- data$PSA_before - data$PSA_after

```



## Data Analysis 0: Correlation between Variables

```{r, eco=FALSE}

vars <- c("Age", "PSA_before", "CTstage", "GleasonScore_before", "Albumin", "Lymphocyte", "CRP", "NLR", "CallyIndex", "ComorbidityScore")

pairs(data[, vars])

```



## Data Analysis 1: Logistic Regression (BCR)

```{r, eco=FALSE}

bcr_model <- glm(BCR ~ Age + PSA_before + CTstage + GleasonScore_before + Albumin + Lymphocyte + CRP + NLR + CallyIndex + ComorbidityScore + Treatment, data = data, family = binomial, na.action = na.omit)

summary(bcr_model)

plot(bcr_model, which = 1)

```

```{r, eco=FALSE}

bcr_model <- glm(BCR ~ PSA_before + Treatment, data = data, family = binomial, na.action = na.omit)

summary(bcr_model)

plot(bcr_model, which = 1)

```



## Data Analysis 2: Logistic Regression (Survival)

```{r, eco=FALSE}

survival_model <- glm(Survival ~ Age + PSA_before + CTstage + GleasonScore_before + Albumin + Lymphocyte + CRP + NLR + CallyIndex + ComorbidityScore + Treatment, data = data, family = binomial, na.action = na.omit)

summary(survival_model)

plot(survival_model, which= 2)

```

```{r, eco=FALSE}

survival_model <- glm(Survival ~ Treatment, data = data, family = binomial, na.action = na.omit)

summary(survival_model)

plot(survival_model, which = 2)

```



## Model Interpretation 1: Logistic Regression (BCR ~ Treatment)

```{r, eco=FALSE}

data$Treatment <- relevel(data$Treatment, ref = 3)

bcr_model_t3 <- glm(BCR ~ PSA_before + Treatment, data = data, family = binomial, na.action = na.omit)

summary(bcr_model_t3)

```



## Model Interpretation 2: Logistic Regression (BCR ~ Combination)

```{r, eco=FALSE}

data$Combination <- ifelse(data$Treatment == 4, "Yes", "No")
data$Combination <- as.factor(data$Combination)

bcr_model_2 <- glm(BCR ~ PSA_before + Combination, data = data,family = binomial, na.action = na.omit)

summary(bcr_model_2)

```



## Model Evaluation:

### Model Fitting and Predicting

```{r, eco=FALSE}

source("00_requirements.R")

vars_for_model <- c("BCR", "PSA_before", "Treatment")
model_data <- data[complete.cases(data[, vars_for_model]), vars_for_model]

set.seed(123)
split_tag <- sample.split(model_data$BCR, SplitRatio = 0.70)
train_set <- subset(model_data, split_tag == TRUE)
test_set <- subset(model_data, split_tag == FALSE)

set.seed(123)
balanced_train_data <- ovun.sample(
    BCR ~ ., 
    data = train_set, 
    method = "over", 
    N = 2 * sum(train_set$BCR == "False") 
)$data

bcr_model_train <- glm(BCR ~ PSA_before + Treatment,data = balanced_train_data, family = binomial)

test_probabilities <- predict(bcr_model_train, newdata = test_set, type = "response")

```


### Evaluating: AUC (Area Under the Curve)

```{r, eco=FALSE}

roc_obj <- roc(test_set$BCR, test_probabilities)
auc_score <- auc(roc_obj)
cat(sprintf("AUC (Area Under the Curve): %.4f\n", auc_score))

```

### Confusion Matrix (Threshold 0.5)

```{r, eco=FALSE}
test_predictions <- ifelse(test_probabilities > 0.5, "True", "False")
conf_matrix <- table(Predicted = test_predictions, Actual = test_set$BCR)
conf_matrix <- conf_matrix[, c("False", "True")]

cat("Confusion Matrix (Threshold 0.5):\n")
print(conf_matrix)

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
sensitivity <- conf_matrix["True", "True"] / sum(conf_matrix[, "True"])
specificity <- conf_matrix["False", "False"] / sum(conf_matrix[, "False"])

cat(sprintf("   Accuracy: %.4f\n", accuracy))
cat(sprintf("   Sensitivity: %.4f\n", sensitivity))
cat(sprintf("   Specificity: %.4f\n", specificity))

```